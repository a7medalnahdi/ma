<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>إدارة جلسة المافيا</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Tajawal', sans-serif;
      background: radial-gradient(circle at center, #1c1c1c 0%, #0d0d0d 100%);
      background-size: cover;
      color: white;
      padding: 20px;
      margin: 0;
      overflow-x: hidden;
    }
    .stars {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: transparent url('https://media.giphy.com/media/3o7abB06u9bNzA8lu8/giphy.gif') repeat;
      background-size: cover;
      opacity: 0.08;
      z-index: -1;
    }
    .box {
      max-width: 800px;
      margin: auto;
      padding: 30px;
      background: rgba(30, 30, 30, 0.9);
      border-radius: 16px;
      box-shadow: 0 0 40px #d32f2f88;
      border: 2px solid #d32f2f;
      animation: fadeIn 1s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    h2 {
      font-size: 26px;
      background: linear-gradient(90deg, #ff4444, #ff0000);
      background-size: 200% auto;
      animation: textGlow 3s linear infinite;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-align: center;
      margin-bottom: 20px;
    }
    @keyframes textGlow {
      0% { background-position: 0% center; }
      100% { background-position: 200% center; }
    }
    input, button {
      padding: 10px;
      margin: 5px;
      border-radius: 10px;
      border: none;
      font-weight: bold;
    }
    button {
      background-color: #d32f2f;
      color: white;
      cursor: pointer;
      box-shadow: 0 0 10px #d32f2f;
      transition: 0.3s ease;
    }
    button:hover {
      transform: scale(1.05);
      box-shadow: 0 0 25px #ff4444, 0 0 40px #ff4444aa;
    }
    .number-control {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .number-control button {
      background-color: #fff;
      color: #d32f2f;
      font-size: 20px;
      width: 36px;
      height: 36px;
      border-radius: 50%;
    }
    input[type=number] {
      width: 50px;
      text-align: center;
      background: #444;
      color: white;
    }
    .code-box {
      background-color: #333;
      padding: 20px;
      border-radius: 15px;
      font-size: 36px;
      font-weight: bold;
      letter-spacing: 4px;
      color: #4caf50;
      margin: 20px auto;
      border: 2px dashed #4caf50;
      text-align: center;
    }
    .player-list li {
      background-color: #2a2a2a;
      padding: 12px;
      margin: 8px 0;
      border-radius: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
    }
    @media (max-width: 600px) {
      .box { padding: 20px; }
      .code-box { font-size: 28px; }
    }
  </style>
</head>
<body>
  <div class="stars"></div>
  <div class="box" id="adminBox">
    <h2>إدارة جلسة المافيا</h2>
    <div id="content">
  <div id="createSessionSection">
    <label>عدد اللاعبين:</label>
    <div class="number-control">
      <button onclick="adjustNumber('players', -1)">-</button>
      <input id="players" type="number" value="4" min="1" readonly>
      <button onclick="adjustNumber('players', 1)">+</button>
    </div>
    <br>
    <label>عدد الأدوار:</label>
    <div class="number-control">
      👨‍👩‍👧‍👦 مواطن
      <button onclick="adjustNumber('citizen', -1)">-</button>
      <input id="citizen" type="number" value="1" min="0" readonly>
      <button onclick="adjustNumber('citizen', 1)">+</button>
    </div>
    <div class="number-control">
      👴🏻 شايب
      <button onclick="adjustNumber('oldman', -1)">-</button>
      <input id="oldman" type="number" value="1" min="0" readonly>
      <button onclick="adjustNumber('oldman', 1)">+</button>
    </div>
    <div class="number-control">
      🕵🏻‍♂️ مافيا
      <button onclick="adjustNumber('mafia', -1)">-</button>
      <input id="mafia" type="number" value="1" min="0" readonly>
      <button onclick="adjustNumber('mafia', 1)">+</button>
    </div>
    <div class="number-control">
      🧑🏻‍⚕️ دكتور
      <button onclick="adjustNumber('doctor', -1)">-</button>
      <input id="doctor" type="number" value="1" min="0" readonly>
      <button onclick="adjustNumber('doctor', 1)">+</button>
    </div>
    <div id="roleSum" style="text-align:center;padding:10px;border-radius:10px;background:#d32f2f;margin:10px 0">
      مجموع الأدوار: 0/0
    </div>
    <button onclick="createSession()">🚀 إنشاء الجلسة</button>
  </div>
  <div id="sessionCodeBox" class="code-box" style="display:none"></div>
  <ul id="playersList" class="player-list"></ul>
</div>
  </div>
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
  <script>
    AOS.init();
  </script>
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
  import { getDatabase, ref, set, get, update, onValue } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";

  const app = initializeApp({
    apiKey: "AIzaSyBP2GPMVxCl2t3n3SFYqWDn585rftcBvGY",
    authDomain: "mifianew.firebaseapp.com",
    databaseURL: "https://mifianew-default-rtdb.firebaseio.com",
    projectId: "mifianew",
    storageBucket: "mifianew.firebasestorage.app",
    messagingSenderId: "90140522196",
    appId: "1:90140522196:web:64613821aa48b8db866d41"
  });

  const db = getDatabase(app);
  let sessionId = "";
  let assignedRoles = [];
  const playersList = document.getElementById("playersList");

  window.adjustNumber = (id, change) => {
    const input = document.getElementById(id);
    const current = parseInt(input.value);
    const newVal = Math.max((input.min ? parseInt(input.min) : 0), current + change);
    input.value = newVal;
    updateTotals();
  };

  window.updateTotals = () => {
    const players = parseInt(document.getElementById("players").value);
    const citizen = parseInt(document.getElementById("citizen").value);
    const oldman = parseInt(document.getElementById("oldman").value);
    const mafia = parseInt(document.getElementById("mafia").value);
    const doctor = parseInt(document.getElementById("doctor").value);
    const rolesSum = citizen + oldman + mafia + doctor;
    const roleSumElement = document.getElementById("roleSum");
    roleSumElement.innerText = `مجموع الأدوار: ${rolesSum}/${players}`;
    roleSumElement.style.backgroundColor = rolesSum === players ? "#4caf50" : "#d32f2f";
  };

  window.onload = () => { updateTotals(); };

  function generateCode() {
    return Math.floor(1000 + Math.random() * 9000).toString();
  }

  window.createSession = async () => {
    const players = parseInt(document.getElementById("players").value);
    const citizen = parseInt(document.getElementById("citizen").value);
    const oldman = parseInt(document.getElementById("oldman").value);
    const mafia = parseInt(document.getElementById("mafia").value);
    const doctor = parseInt(document.getElementById("doctor").value);
    const rolesSum = citizen + oldman + mafia + doctor;
    if (rolesSum !== players) return alert("عدد الأدوار لا يطابق عدد اللاعبين!");
    sessionId = generateCode();
    const roles = { citizen, oldman, mafia, doctor };
    await set(ref(db, `sessions/${sessionId}`), {
      players,
      roles,
      playersList: [],
      started: false,
      points: {}
    });
    document.getElementById("createSessionSection").style.display = "none";
    const codeBox = document.getElementById("sessionCodeBox");
    codeBox.innerText = sessionId;
    codeBox.style.display = "block";
    const sessionRef = ref(db, `sessions/${sessionId}`);
    onValue(sessionRef, (snap) => {
      const data = snap.val();
      assignedRoles = data.assignedRoles || [];
      playersList.innerHTML = "";
      data.playersList?.forEach(p => {
        const role = assignedRoles.find(r => r.name === p.name)?.role || "—";
        const li = document.createElement("li");
        li.innerHTML = `<div style="flex:1">👤 ${p.name} - 🎭 <strong style="color:#4caf50">${role}</strong> - 🏅 ${p.points || 0}</div>`;
        playersList.appendChild(li);
      });
    });
  };
</script>
</body>
</html>
